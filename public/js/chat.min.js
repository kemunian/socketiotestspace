var url=window.location.href,socket=null,stateMenu=0,username=null,usernameChat=null,roomChat=null,disconnectUsers={};function main(){$("#chatRoomsButton").click(toogleMenu),$("#btConnect").click(startSocket),$("#loginTextBox").keydown(onTextboxLoginKeydown),$("#popConnect").modal({backdrop:"static",keyboard:!1}),$("#popConnect").on("shown.bs.modal",function(){$("#loginTextBox").focus()}),$("#chatSendButton").click(sendMessage),$("#chatTextBox").keydown(onTextboxChatKeydown)}function toogleMenu(){1==stateMenu?hideMenuToLeft():0==stateMenu&&showMenuFromLeft()}function showMenuFromLeft(){stateMenu=-1,$("#chatRoomsButtonIcon").removeClass("chatRoomsButtonIconAnimate"),$("#chat").removeClass("col-xs-12 col-sm-12 col-md-8 col-lg-9"),$("#chat").addClass("widthAll"),$("#chatRooms").removeClass("heightAll hidden-xs hidden-sm col-md-4 col-lg-3"),$("#chatRooms").addClass("chatRoomsShow"),$("#chatRooms").animate({left:"0px"},700,function(){stateMenu=1})}function hideMenuToLeft(){stateMenu=-1,$("#chatRooms").animate({left:"-75%"},700,function(){$("#chatRooms").css("left",""),$("#chatRooms").removeClass("chatRoomsShow"),$("#chatRooms").addClass("heightAll hidden-xs hidden-sm col-md-4 col-lg-3"),$("#chat").removeClass("widthAll"),$("#chat").addClass("col-xs-12 col-sm-12 col-md-8 col-lg-9"),stateMenu=0})}function onTextboxLoginKeydown(e){13==e.which&&startSocket()}function onTextboxChatKeydown(e){13==e.which&&sendMessage()}function loadRooms(e){$("#listRoom").empty();for(var t=0;t<e.length;t++){var s=$("<span>").attr("class","fa fa-users listItemUserIconConnect"),a=$("<span>").append(e[t]),n=$("<li>").attr("id","room_"+e[t]).attr("class","listItemRoom");n.append(s),n.append(a),n.on("click",loadChatRoom),$("#listRoom").append(n)}}function loadUsers(e){$("#listUsers").empty();for(var t,s=0;s<e.length;s++)username!=e[s]&&(t=createUserItemList(e[s]),$("#listUsers").append(t))}function addUser(e){var t=createUserItemList(e),s=$("#listUsers li");if(0<s.length){for(var a=s.length-1,n=!1;0<=a&&!n;)s[a].id.replace("user_","")<e&&(n=!0,$("#"+s[a].id).after(t)),a--;a<0&&!n&&$("#listUsers").prepend(t)}else $("#listUsers").append(t)}function createUserItemList(e){var t=$("<span>").attr("id","userIcon_"+e).attr("class","fa fa-user listItemUserIconConnect"),s=$("<span>").append(e),a=$("<span>").attr("id","userBadge_"+e).attr("class","badge listItemUserBagde hidden").append(0),e=$("<li>").attr("id","user_"+e).attr("class","listItemRoom");return e.append(t),e.append(s),e.append(a),e.on("click",loadChatUser),e}function loadChatMessages(e,t){var s=null,a=null;$("#listChat").empty();for(var n=0;n<e.length;n++)a=new Date(e[n].datetime),(0==n||s.getFullYear()<a.getFullYear()||s.getMonth()<a.getMonth()||s.getDay()<a.getDay())&&addMessageDate(a),addMessage(e[n],t),s=a}function loadChatMessagesForUser(e){loadChatMessages(e,!1),$("#usernameChat").text(usernameChat),null==disconnectUsers[usernameChat]?($("#usernameChat").css({"text-decoration":"initial"}),$("#chatTextBox").removeAttr("disabled"),$("#chatSendButton").removeClass("disabled")):($("#usernameChat").css({"text-decoration":"line-through"}),$("#chatTextBox").attr("disabled",""),$("#chatSendButton").addClass("disabled")),1==stateMenu&&hideMenuToLeft(),$("#userBadge_"+usernameChat).text("0"),$("#userBadge_"+usernameChat).addClass("hidden"),roomChat=null}function loadChatMessagesForRoom(e){loadChatMessages(e,!0),$("#usernameChat").text("Room: "+roomChat),$("#usernameChat").css({"text-decoration":"initial"}),$("#chatTextBox").removeAttr("disabled"),$("#chatSendButton").removeClass("disabled"),1==stateMenu&&hideMenuToLeft(),usernameChat=null}function addMessage(e,t){null==t&&(t=!1);var s=null,a=null,n=$("<table>"),o=$("<tr>"),r=null,l=null;e.userSend==username?(s=$("<li>").attr("class","listItemMsg listItemMsgSend"),a=$("<div>").attr("class","msg msgSend"),r=$("<td>").attr("class","tdMsgSendText").append(e.text),l=$("<td>").attr("class","tdMsgSendHour").append(formatTime(new Date(e.datetime)))):(s=$("<li>").attr("class","listItemMsg listItemMsgReceive"),a=$("<div>").attr("class","msg msgReceive"),r=$("<td>").attr("class","tdMsgReceiveText").append(e.text),l=$("<td>").attr("class","tdMsgReceiveHour").append(formatTime(new Date(e.datetime))),t&&(t=$("<tr>"),e=$("<td>").attr("colspan","2").attr("class","tdMsgReceiveUser").append(e.userSend),t.append(e),n.append(t))),o.append(r),o.append(l),n.append(o),a.append(n),s.append(a),$("#listChat").append(s),$("#listChat").scrollTop($("#listChat")[0].scrollHeight)}function addMessageDate(e){var t=$("<li>").attr("class","listItemMsg listItemMsgDate"),e=$("<div>").attr("class","msg msgDate").append(e.toDateString());t.append(e),$("#listChat").append(t),$("#listChat").scrollTop($("#listChat")[0].scrollHeight)}function formatTime(e){var t="",t=e.getHours()<10?"0"+e.getHours():e.getHours();return t+=":",e.getMinutes()<10?t=t+"0"+e.getMinutes():t+=e.getMinutes(),t}function startSocket(){""!=(username=$("#loginTextBox").val())&&null!=username&&((socket=new io.connect(url)).on("connect",connectUser),socket.on("joinUserDone",onJoinUserDone),socket.on("joinUserError",onJoinUserError),socket.on("userConnected",onUserConnected),socket.on("userDisconnected",onUserDisconnected),socket.on("messageUser",onMessageUser),socket.on("messageRoom",onMessageRoom))}function connectUser(){null!=socket&&socket.connected&&socket.emit("joinUser",{username:username})}function onJoinUserDone(e){null!=e.rooms&&loadRooms(e.rooms),null!=e.users&&loadUsers(e.users),$("#username").text(username),$("#popConnect").modal("toggle"),$("#loginTextBox").val(null)}function onJoinUserError(){var e,t,s,a;0==$("#joinError").length&&(e=$("<div>").attr("id","joinError").attr("class","alert alert-danger").css({"margin-top":"5px"}),t=$("<a>").attr("class","close").attr("data-dismiss","alert").attr("aria-label","close").attr("href","#").append("&times;"),s=$("<strong>").append("The username is being used."),a=$("<strong>").append("Try again."),e.append(t),e.append(s),e.append("<br>"),e.append(a),$("#popConnectContent").append(e))}function onUserConnected(e){null!=disconnectUsers[e.userOn]?(delete disconnectUsers[e.userOn],$("#userIcon_"+e.userOn).removeClass("listItemUserIconDisconnect"),$("#userIcon_"+e.userOn).addClass("listItemUserIconConnect"),e.userOn==usernameChat&&($("#usernameChat").css({"text-decoration":"initial"}),$("#chatTextBox").removeAttr("disabled"),$("#chatSendButton").removeClass("disabled"))):addUser(e.userOn)}function onUserDisconnected(e){disconnectUsers[e.userOff]="",$("#userIcon_"+e.userOff).removeClass("listItemUserIconConnect"),$("#userIcon_"+e.userOff).addClass("listItemUserIconDisconnect"),e.userOff==usernameChat&&($("#usernameChat").css({"text-decoration":"line-through"}),$("#chatTextBox").attr("disabled",""),$("#chatSendButton").addClass("disabled"))}function loadChatUser(){null!=socket&&socket.connected&&(roomChat=null,usernameChat=this.id.replace("user_",""),socket.emit("loadChatUser",usernameChat,loadChatMessagesForUser))}function loadChatRoom(){null!=socket&&socket.connected&&(usernameChat=null,roomChat=this.id.replace("room_",""),socket.emit("joinToRoom",roomChat,loadChatMessagesForRoom))}function sendMessage(){var e;null!=socket&&socket.connected&&""!=$("#chatTextBox").val()&&((e={}).text=$("#chatTextBox").val(),null!=usernameChat?(e.username=usernameChat,socket.emit("sendMessageUser",e)):null!=roomChat&&(e.room=roomChat,socket.emit("sendMessageRoom",e)),$("#chatTextBox").val(null))}function onMessageUser(e){null==usernameChat||e.userSend!=usernameChat&&e.userSend!=username?(t=parseInt($("#userBadge_"+e.userSend).text()),t++,$("#userBadge_"+e.userSend).text(t),$("#userBadge_"+e.userSend).removeClass("hidden"),0==stateMenu&&$("#chatRoomsButtonIcon").addClass("chatRoomsButtonIconAnimate")):addMessage(e,!1);var t=$("#user_"+e.userSend);$("#listUsers #user_"+e.userSend).remove(),t.on("click",loadChatUser),$("#listUsers").prepend(t)}function onMessageRoom(e){null!=roomChat&&addMessage(e,!0)}$(document).ready(main);